<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì˜¤ì–´ ë¬´í•œë§¤ìˆ˜ë²• ì‹œë®¬ë ˆì´í„°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #1a1a2e; color: #eee; font-family: 'Segoe UI', sans-serif; }
        .card { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; }
        .card-header { background: #0f3460; border-radius: 12px 12px 0 0 !important; }
        .btn-primary { background: #e94560; border: none; }
        .btn-primary:hover { background: #c73e54; }
        .btn-success { background: #4CAF50; border: none; }
        .form-control, .form-select { background: #1a1a2e; color: #eee; border: 1px solid #0f3460; }
        .form-control:focus, .form-select:focus { background: #1a1a2e; color: #eee; border-color: #e94560; box-shadow: 0 0 0 0.2rem rgba(233,69,96,0.25); }
        .table { color: #eee; }
        .table-striped>tbody>tr:nth-of-type(odd) { color: #eee; background-color: rgba(15,52,96,0.3); }
        .hero { text-align: center; padding: 40px 0 20px; }
        .hero h1 { font-size: 2.5rem; font-weight: bold; }
        .hero .subtitle { color: #e94560; font-size: 1.2rem; }
        .stat-card { background: #0f3460; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: #e94560; }
        .stat-card .label { color: #aaa; font-size: 0.9rem; }
        #loading { display: none; }
        .spinner-border { width: 3rem; height: 3rem; }
        .tab-content { padding-top: 20px; }
        .nav-tabs .nav-link { color: #aaa; }
        .nav-tabs .nav-link.active { background: #16213e; color: #e94560; border-color: #0f3460 #0f3460 #16213e; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="hero">
            <h1>ğŸš€ ë¬´í•œë§¤ìˆ˜ë²• ì‹œë®¬ë ˆì´í„°</h1>
            <p class="subtitle">ë¼ì˜¤ì–´ì˜ ë¬´í•œë§¤ìˆ˜ ì „ëµ ë°±í…ŒìŠ¤íŠ¸ & ì£¼ë¬¸ í‘œ ìƒì„±</p>
        </div>

        <!-- íƒ­ -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#backtest-tab">ğŸ“Š ë°±í…ŒìŠ¤íŠ¸</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#table-tab">ğŸ“‹ ì£¼ë¬¸ í‘œ</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- ë°±í…ŒìŠ¤íŠ¸ íƒ­ -->
            <div class="tab-pane fade show active" id="backtest-tab">
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0">âš™ï¸ ì„¤ì •</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ì¢…ëª© ì½”ë“œ</label>
                                    <input type="text" class="form-control" id="ticker" value="TQQQ">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ë¶„í•  íšŸìˆ˜</label>
                                    <select class="form-select" id="divisions">
                                        <option value="20">20ë¶„í• </option>
                                        <option value="40" selected>40ë¶„í• </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì´ íˆ¬ìê¸ˆ (ì›)</label>
                                    <input type="number" class="form-control" id="total_investment" value="10000000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ëª©í‘œ ìˆ˜ìµë¥  (%)</label>
                                    <input type="number" class="form-control" id="target_profit_pct" value="5.0" step="0.5">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="use_loc" checked>
                                    <label class="form-check-label">LOC ì£¼ë¬¸ ì‚¬ìš©</label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">LOC í• ì¸ìœ¨ (%)</label>
                                    <input type="number" class="form-control" id="loc_discount_pct" value="1.0" step="0.1">
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label">ì‹œì‘ì¼</label>
                                    <input type="date" class="form-control" id="start_date" value="2024-01-01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì¢…ë£Œì¼</label>
                                    <input type="date" class="form-control" id="end_date" value="2024-12-31">
                                </div>
                                <button class="btn btn-primary w-100" onclick="runBacktest()">
                                    ğŸš€ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <!-- ë¡œë”© -->
                        <div id="loading" class="text-center py-5">
                            <div class="spinner-border text-danger" role="status"></div>
                            <p class="mt-3">ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘... â³</p>
                        </div>

                        <!-- ê²°ê³¼ -->
                        <div id="results" style="display:none;">
                            <!-- ì„±ê³¼ ì¹´ë“œ -->
                            <div class="row mb-3" id="stats-row"></div>

                            <!-- ì°¨íŠ¸ -->
                            <div class="card mb-3">
                                <div class="card-header"><h5 class="mb-0">ğŸ“ˆ ì°¨íŠ¸</h5></div>
                                <div class="card-body text-center">
                                    <img id="chart-img" class="img-fluid" style="border-radius: 8px;">
                                </div>
                            </div>

                            <!-- ë§¤ë§¤ ê¸°ë¡ -->
                            <div class="card">
                                <div class="card-header"><h5 class="mb-0">ğŸ“ ë§¤ë§¤ ê¸°ë¡</h5></div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="trades-table"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì£¼ë¬¸ í‘œ íƒ­ -->
            <div class="tab-pane fade" id="table-tab">
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ì‹œì‘ ê°€ê²©</label>
                                    <input type="number" class="form-control" id="start_price" value="100" step="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">íšŒì°¨ë³„ ê°€ê²© ë³€í™”ìœ¨ (%)</label>
                                    <input type="number" class="form-control" id="price_step" value="-1.0" step="0.5">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ë¶„í•  íšŸìˆ˜</label>
                                    <select class="form-select" id="table_divisions">
                                        <option value="20">20ë¶„í• </option>
                                        <option value="40" selected>40ë¶„í• </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì´ íˆ¬ìê¸ˆ (ì›)</label>
                                    <input type="number" class="form-control" id="table_investment" value="10000000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ëª©í‘œ ìˆ˜ìµë¥  (%)</label>
                                    <input type="number" class="form-control" id="table_profit" value="5.0" step="0.5">
                                </div>
                                <button class="btn btn-success w-100" onclick="generateTable()">
                                    ğŸ“‹ ì£¼ë¬¸ í‘œ ìƒì„±
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0">ğŸ“‹ ì£¼ë¬¸ í‘œ</h5></div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <div id="order-table">
                                    <p class="text-muted text-center py-5">ì„¤ì • í›„ "ì£¼ë¬¸ í‘œ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-4 py-3" style="color: #555;">
            ë¼ì˜¤ì–´ ë¬´í•œë§¤ìˆ˜ë²• ì‹œë®¬ë ˆì´í„° v1.0 | âš ï¸ íˆ¬ì ì†ì‹¤ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function runBacktest() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            const payload = {
                ticker: document.getElementById('ticker').value,
                divisions: document.getElementById('divisions').value,
                total_investment: document.getElementById('total_investment').value,
                target_profit_pct: document.getElementById('target_profit_pct').value,
                use_loc: document.getElementById('use_loc').checked,
                loc_discount_pct: document.getElementById('loc_discount_pct').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
            };

            try {
                const resp = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();

                if (data.success) {
                    // ì„±ê³¼ ì¹´ë“œ
                    const perf = data.performance;
                    const investment = parseInt(payload.total_investment).toLocaleString();
                    document.getElementById('stats-row').innerHTML = `
                        <div class="col-3"><div class="stat-card">
                            <div class="value">${perf.total_return_pct}%</div>
                            <div class="label">ì´ ìˆ˜ìµë¥ </div>
                        </div></div>
                        <div class="col-3"><div class="stat-card">
                            <div class="value">${perf.cycles_completed}</div>
                            <div class="label">ì™„ë£Œ ì‚¬ì´í´</div>
                        </div></div>
                        <div class="col-3"><div class="stat-card">
                            <div class="value">${perf.total_cycles}</div>
                            <div class="label">ì´ ì‚¬ì´í´</div>
                        </div></div>
                        <div class="col-3"><div class="stat-card">
                            <div class="value">${data.total_trades}</div>
                            <div class="label">ì´ ë§¤ë§¤ íšŸìˆ˜</div>
                        </div></div>
                    `;

                    // ì°¨íŠ¸
                    if (data.chart) {
                        document.getElementById('chart-img').src = 'data:image/png;base64,' + data.chart;
                    }

                    // ë§¤ë§¤ ê¸°ë¡
                    document.getElementById('trades-table').innerHTML = data.trades_html;

                    document.getElementById('results').style.display = 'block';
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
            }

            document.getElementById('loading').style.display = 'none';
        }

        async function generateTable() {
            const payload = {
                start_price: document.getElementById('start_price').value,
                price_step: document.getElementById('price_step').value,
                divisions: document.getElementById('table_divisions').value,
                total_investment: document.getElementById('table_investment').value,
                target_profit_pct: document.getElementById('table_profit').value,
                use_loc: true,
                loc_discount_pct: 1.0,
            };

            try {
                const resp = await fetch('/api/order_table', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('order-table').innerHTML = data.table_html;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
            }
        }
    </script>
</body>
</html>
