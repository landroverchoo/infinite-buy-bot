<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì˜¤ì–´ ë¬´í•œë§¤ìˆ˜ë²• V3.0 ì‹œë®¬ë ˆì´í„°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Nanum Gothic', sans-serif; }
        body { background: #f5f7fa; color: #333; font-size: 16px; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .card-header { background: #1a73e8; color: #fff; border-radius: 16px 16px 0 0 !important; padding: 14px 20px; }
        .card-header h5 { margin: 0; font-weight: 800; font-size: 1.1rem; }
        .btn-primary { background: #1a73e8; border: none; font-weight: 700; padding: 12px; font-size: 1rem; border-radius: 10px; }
        .btn-primary:hover { background: #1557b0; }
        .btn-success { background: #34a853; border: none; font-weight: 700; padding: 12px; font-size: 1rem; border-radius: 10px; }
        .btn-success:hover { background: #2d8f47; }
        .form-control, .form-select {
            background: #fff; color: #333; border: 1.5px solid #ddd;
            border-radius: 10px; padding: 10px 14px; font-size: 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.15);
        }
        .form-label { font-weight: 700; color: #555; margin-bottom: 4px; font-size: 0.9rem; }
        .table { color: #333; font-size: 0.85rem; }
        .table th { background: #f0f4f8; font-weight: 800; position: sticky; top: 0; }
        .table-striped>tbody>tr:nth-of-type(odd) { background-color: #f8fafc; }
        .hero { text-align: center; padding: 30px 10px 15px; }
        .hero h1 { font-size: 1.8rem; font-weight: 800; color: #1a73e8; }
        .hero .subtitle { color: #666; font-size: 1rem; margin-top: 4px; }
        .stat-card {
            background: #fff; border-radius: 14px; padding: 16px 10px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e8e8e8;
        }
        .stat-card .value { font-size: 1.6rem; font-weight: 800; color: #1a73e8; }
        .stat-card .label { color: #888; font-size: 0.8rem; font-weight: 700; margin-top: 2px; }
        #loading { display: none; }
        .spinner-border { width: 2.5rem; height: 2.5rem; color: #1a73e8 !important; }
        .nav-tabs { border-bottom: 2px solid #e0e0e0; }
        .nav-tabs .nav-link {
            color: #888; font-weight: 700; font-size: 1rem;
            border: none; padding: 10px 20px; border-radius: 10px 10px 0 0;
        }
        .nav-tabs .nav-link.active {
            background: #fff; color: #1a73e8;
            border: 2px solid #e0e0e0; border-bottom: 2px solid #fff;
        }
        .form-check-input:checked { background-color: #1a73e8; border-color: #1a73e8; }
        footer { color: #aaa; font-size: 0.8rem; }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .hero h1 { font-size: 1.4rem; }
            .hero .subtitle { font-size: 0.85rem; }
            .stat-card .value { font-size: 1.3rem; }
            .stat-card .label { font-size: 0.75rem; }
            .stat-card { padding: 12px 6px; }
            .stats-row .col { padding: 4px !important; }
            .card-body { padding: 14px; }
            .card-header { padding: 12px 14px; }
            .table { font-size: 0.75rem; }
            .table td, .table th { padding: 6px 4px; white-space: nowrap; }
            .nav-tabs .nav-link { font-size: 0.9rem; padding: 8px 14px; }
            .btn-primary, .btn-success { padding: 10px; }
            .container { padding-left: 10px; padding-right: 10px; }
            .chart-container { overflow-x: auto; }
            .chart-container img { min-width: 600px; }
        }
    </style>
</head>
<body>
    <div class="container py-3">
        <div class="hero">
            <h1>ğŸš€ ë¬´í•œë§¤ìˆ˜ë²• V3.0 ì‹œë®¬ë ˆì´í„°</h1>
            <p class="subtitle">ë¼ì˜¤ì–´ì˜ ë¬´í•œë§¤ìˆ˜ ì „ëµ ë°±í…ŒìŠ¤íŠ¸ & ì£¼ë¬¸ í‘œ</p>
        </div>

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#backtest-tab">ğŸ“Š ë°±í…ŒìŠ¤íŠ¸</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#table-tab">ğŸ“‹ ì£¼ë¬¸ í‘œ</a>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- ë°±í…ŒìŠ¤íŠ¸ íƒ­ -->
            <div class="tab-pane fade show active" id="backtest-tab">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <div class="card">
                            <div class="card-header"><h5>âš™ï¸ ì„¤ì •</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ì¢…ëª© ì½”ë“œ</label>
                                    <select class="form-select" id="ticker" onchange="updateStarFormula()">
                                        <option value="TQQQ" selected>TQQQ (ë³„% = 15 - 1.5T)</option>
                                        <option value="SOXL">SOXL (ë³„% = 20 - 2T)</option>
                                    </select>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">ë¶„í•  íšŸìˆ˜</label>
                                        <select class="form-select" id="divisions">
                                            <option value="20">20ë¶„í•  (ê³ ìœ„í—˜)</option>
                                            <option value="30">30ë¶„í• </option>
                                            <option value="40" selected>40ë¶„í•  (ê¶Œì¥)</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">ëª©í‘œ ìˆ˜ìµë¥ </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="target_profit_pct" value="5.0" step="0.5">
                                            <span class="input-group-text" style="background:#f0f4f8;border:1.5px solid #ddd;">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì´ íˆ¬ìê¸ˆ (ì›)</label>
                                    <input type="number" class="form-control" id="total_investment" value="10000000">
                                </div>
                                <hr style="border-color:#e8e8e8;">
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">ì‹œì‘ì¼</label>
                                        <input type="date" class="form-control" id="start_date" value="2024-01-01">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">ì¢…ë£Œì¼</label>
                                        <input type="date" class="form-control" id="end_date" value="2024-12-31">
                                    </div>
                                </div>
                                <button class="btn btn-primary w-100" onclick="runBacktest()">
                                    ğŸš€ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <div id="loading" class="text-center py-5">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-3" style="color:#666;font-weight:700;">ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘... â³</p>
                        </div>

                        <div id="results" style="display:none;">
                            <div class="row g-2 mb-3 stats-row" id="stats-row"></div>

                            <div class="card mb-3">
                                <div class="card-header"><h5>ğŸ“ˆ ì°¨íŠ¸</h5></div>
                                <div class="card-body chart-container">
                                    <img id="chart-img" class="img-fluid" style="border-radius: 8px; width:100%;">
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header"><h5>ğŸ“ ë§¤ë§¤ ê¸°ë¡</h5></div>
                                <div class="card-body" style="max-height: 400px; overflow: auto;">
                                    <div id="trades-table"></div>
                                </div>
                            </div>
                        </div>

                        <div id="placeholder" class="text-center py-5" style="color:#aaa;">
                            <p style="font-size:3rem;">ğŸ“Š</p>
                            <p style="font-weight:700;">ì„¤ì • í›„ "ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</p>
                            <p class="mt-2" style="font-size:0.85rem;color:#777;">
                                <strong>T = ë§¤ìˆ˜ëˆ„ì ì•¡ / 1íšŒë§¤ìˆ˜ì•¡</strong> (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ ì˜¬ë¦¼)<br>
                                <span id="star_formula">ë³„% = 15 - 1.5T (TQQQ ê¸°ì¤€)</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì£¼ë¬¸ í‘œ íƒ­ -->
            <div class="tab-pane fade" id="table-tab">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <div class="card">
                            <div class="card-header" style="background:#34a853;"><h5>âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ì‹œì‘ ê°€ê²©</label>
                                    <input type="number" class="form-control" id="start_price" value="100" step="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">íšŒì°¨ë³„ ê°€ê²© ë³€í™”ìœ¨</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="price_step" value="-1.0" step="0.5">
                                        <span class="input-group-text" style="background:#f0f4f8;border:1.5px solid #ddd;">%</span>
                                    </div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">ë¶„í•  íšŸìˆ˜</label>
                                        <select class="form-select" id="table_divisions">
                                            <option value="20">20ë¶„í•  (ê³ ìœ„í—˜)</option>
                                            <option value="30">30ë¶„í• </option>
                                            <option value="40" selected>40ë¶„í•  (ê¶Œì¥)</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">ëª©í‘œ ìˆ˜ìµë¥ </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="table_profit" value="5.0" step="0.5">
                                            <span class="input-group-text" style="background:#f0f4f8;border:1.5px solid #ddd;">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì¢…ëª© ì½”ë“œ</label>
                                    <select class="form-select" id="table_ticker">
                                        <option value="TQQQ" selected>TQQQ (ë³„% = 15 - 1.5T)</option>
                                        <option value="SOXL">SOXL (ë³„% = 20 - 2T)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ì´ íˆ¬ìê¸ˆ (ì›)</label>
                                    <input type="number" class="form-control" id="table_investment" value="10000000">
                                </div>
                                <button class="btn btn-success w-100" onclick="generateTable()">
                                    ğŸ“‹ ì£¼ë¬¸ í‘œ ìƒì„±
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <div class="card">
                            <div class="card-header" style="background:#34a853;"><h5>ğŸ“‹ ì£¼ë¬¸ í‘œ</h5></div>
                            <div class="card-body" style="max-height: 600px; overflow: auto;">
                                <div id="order-table">
                                    <p class="text-center py-5" style="color:#aaa;">
                                        <span style="font-size:3rem;">ğŸ“‹</span><br>
                                        <span style="font-weight:700;">ì„¤ì • í›„ "ì£¼ë¬¸ í‘œ ìƒì„±" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-4 py-3">
            ë¬´í•œë§¤ìˆ˜ë²• V3.0 ì‹œë®¬ë ˆì´í„° | âš ï¸ íˆ¬ì ì†ì‹¤ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function runBacktest() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('placeholder').style.display = 'none';

            const payload = {
                ticker: document.getElementById('ticker').value,
                divisions: document.getElementById('divisions').value,
                total_investment: document.getElementById('total_investment').value,
                target_profit_pct: document.getElementById('target_profit_pct').value,
                use_loc: document.getElementById('use_loc').checked,
                loc_discount_pct: document.getElementById('loc_discount_pct').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
            };

            try {
                const resp = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();

                if (data.success) {
                    const perf = data.performance;
                    const retColor = perf.total_return_pct >= 0 ? '#ea4335' : '#1a73e8';
                    document.getElementById('stats-row').innerHTML = `
                        <div class="col-3 col"><div class="stat-card">
                            <div class="value" style="color:${retColor}">${perf.total_return_pct}%</div>
                            <div class="label">ì´ ìˆ˜ìµë¥ </div>
                        </div></div>
                        <div class="col-3 col"><div class="stat-card">
                            <div class="value">${perf.cycles_completed}</div>
                            <div class="label">ì™„ë£Œ ì‚¬ì´í´</div>
                        </div></div>
                        <div class="col-3 col"><div class="stat-card">
                            <div class="value">${perf.total_cycles}</div>
                            <div class="label">ì´ ì‚¬ì´í´</div>
                        </div></div>
                        <div class="col-3 col"><div class="stat-card">
                            <div class="value">${data.total_trades}</div>
                            <div class="label">ë§¤ë§¤ íšŸìˆ˜</div>
                        </div></div>
                    `;
                    if (data.chart) {
                        document.getElementById('chart-img').src = 'data:image/png;base64,' + data.chart;
                    }
                    document.getElementById('trades-table').innerHTML = data.trades_html;
                    document.getElementById('results').style.display = 'block';
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                    document.getElementById('placeholder').style.display = 'block';
                }
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
                document.getElementById('placeholder').style.display = 'block';
            }
            document.getElementById('loading').style.display = 'none';
        }

        async function generateTable() {
            const payload = {
                start_price: document.getElementById('start_price').value,
                price_step: document.getElementById('price_step').value,
                divisions: document.getElementById('table_divisions').value,
                total_investment: document.getElementById('table_investment').value,
                target_profit_pct: document.getElementById('table_profit').value,
                ticker: document.getElementById('table_ticker').value,
                use_loc: true,
                loc_discount_pct: 1.0,
            };
            try {
                const resp = await fetch('/api/order_table', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('order-table').innerHTML = data.table_html;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
            }
        }

        function updateStarFormula() {
            const ticker = document.getElementById('ticker').value;
            const formulaEl = document.getElementById('star_formula');
            if (ticker === 'TQQQ') {
                formulaEl.textContent = 'ë³„% = 15 - 1.5T (TQQQ ê¸°ì¤€)';
            } else if (ticker === 'SOXL') {
                formulaEl.textContent = 'ë³„% = 20 - 2T (SOXL ê¸°ì¤€)';
            }
        }
    </script>
</body>
</html>
